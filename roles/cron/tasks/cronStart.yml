---
# The source code packaged with this file is Free Software, Copyright (C) 2016 by
# Unidad de Laboratorios, Escuela Politecnica Superior, Universidad de Alicante :: <aeps at eps.ua.es>.
# It's licensed under the AFFERO GENERAL PUBLIC LICENSE unless stated otherwise.
# You can get copies of the licenses here: http://www.affero.org/oagpl.html
# AFFERO GENERAL PUBLIC LICENSE is also included in the file called "LICENSE".


# Crontab Configuration (add entries)

- name: Add ansibleEPS task to crontab file
  cron: 'name="ansibleEPS" minute="{{ minutesCron }}" hour="{{ hoursCron }}" day="{{ dayCron }}" weekday="{{ weekdayCron }}" month="{{ monthCron }}" job="cd {{ pathAnsible }} && (ini=$(date); timestamp=$(date +\"\%y\%m\%d-\%H\%M\"); ansible-playbook {{ pathAnsible }}/common.yml > /var/log/ansibleEPS/.common.$timestamp.log.tmp 2>&1; [ $? -gt 0 ] && ((echo; echo \"### ERRORS common.yml - $ini TO $(date) ###\"; echo; cat /var/log/ansibleEPS/.common.$timestamp.log.tmp) >> /var/log/ansibleEPS/errors.log); [ `grep \"changed=\" /var/log/ansibleEPS/.common.$timestamp.log.tmp|grep -v \"changed=0\"|wc -l` -gt 0 ] && ((echo; echo \"### CHANGES common.yml - $ini TO $(date) ###\"; echo; grep /var/log/ansibleEPS/.common.$timestamp.log.tmp -e \"^PLAY \" -e \"^TASK \" -e \"changed:\" -e \"changed=\"; echo) >> /var/log/ansibleEPS/changes.log); rm -f /var/log/ansibleEPS/.common.$timestamp.log.tmp; echo \"### common.yml - $ini TO $(date) ###\" >> /var/log/ansibleEPS/summary.log; ini=$(date); timestamp=$(date +\"\%y\%m\%d-\%H\%M\"); ansible-playbook {{ pathAnsible }}/hostsFile.yml > /var/log/ansibleEPS/.hostsFile.$timestamp.log.tmp 2>&1; [ $? -gt 0 ] && ((echo; echo \"### ERRORS hostsFile.yml - $ini TO $(date) ###\"; echo; cat /var/log/ansibleEPS/.hostsFile.$timestamp.log.tmp) >> /var/log/ansibleEPS/errors.log); [ `grep \"changed=\" /var/log/ansibleEPS/.hostsFile.$timestamp.log.tmp|grep -v \"changed=0\"|wc -l` -gt 0 ] && ((echo; echo \"### CHANGES hostsFile.yml - $ini TO $(date) ###\"; echo; grep /var/log/ansibleEPS/.hostsFile.$timestamp.log.tmp -e \"^PLAY \" -e \"^TASK \" -e \"changed:\" -e \"changed=\"; echo) >> /var/log/ansibleEPS/changes.log); rm -f /var/log/ansibleEPS/.hostsFile.$timestamp.log.tmp; echo \"### hostFile.yml - $ini TO $(date) ###\" >> /var/log/ansibleEPS/summary.log; ini=$(date); timestamp=$(date +\"\%y\%m\%d-\%H\%M\"); ansible-playbook {{ pathAnsible }}/sudo.yml > /var/log/ansibleEPS/.sudo.$timestamp.log.tmp 2>&1; [ $? -gt 0 ] && ((echo; echo \"### ERRORS sudo.yml - $ini TO $(date) ###\"; echo; cat /var/log/ansibleEPS/.sudo.$timestamp.log.tmp) >> /var/log/ansibleEPS/errors.log); [ `grep \"changed=\" /var/log/ansibleEPS/.sudo.$timestamp.log.tmp|grep -v \"changed=0\"|wc -l` -gt 0 ] && ((echo; echo \"### CHANGES sudo.yml - $ini TO $(date) ###\"; echo; grep /var/log/ansibleEPS/.sudo.$timestamp.log.tmp -e \"^PLAY \" -e \"^TASK \" -e \"changed:\" -e \"changed=\"; echo) >> /var/log/ansibleEPS/changes.log); rm -f /var/log/ansibleEPS/.sudo.$timestamp.log.tmp; echo \"### sudo.yml - $ini TO $(date) ###\" >> /var/log/ansibleEPS/summary.log; ini=$(date); timestamp=$(date +\"\%y\%m\%d-\%H\%M\"); ansible-playbook {{ pathAnsible }}/wrappers.yml > /var/log/ansibleEPS/.wrappers.$timestamp.log.tmp 2>&1; [ $? -gt 0 ] && ((echo; echo \"### ERRORS wrappers.yml - $ini TO $(date) ###\"; echo; cat /var/log/ansibleEPS/.wrappers.$timestamp.log.tmp) >> /var/log/ansibleEPS/errors.log); [ `grep \"changed=\" /var/log/ansibleEPS/.wrappers.$timestamp.log.tmp|grep -v \"changed=0\"|wc -l` -gt 0 ] && ((echo; echo \"### CHANGES wrappers.yml - $ini TO $(date) ###\"; echo; grep /var/log/ansibleEPS/.wrappers.$timestamp.log.tmp -e \"^PLAY \" -e \"^TASK \" -e \"changed:\" -e \"changed=\"; echo) >> /var/log/ansibleEPS/changes.log); rm -f /var/log/ansibleEPS/.wrappers.$timestamp.log.tmp; echo \"### wrappers.yml - $ini TO $(date) ###\" >> /var/log/ansibleEPS/summary.log; ini=$(date); timestamp=$(date +\"\%y\%m\%d-\%H\%M\"); ansible-playbook {{ pathAnsible }}/pamAccess.yml > /var/log/ansibleEPS/.pamAccess.$timestamp.log.tmp 2>&1; [ $? -gt 0 ] && ((echo; echo \"### ERRORS pamAccess.yml - $ini TO $(date) ###\"; echo; cat /var/log/ansibleEPS/.pamAccess.$timestamp.log.tmp) >> /var/log/ansibleEPS/errors.log); [ `grep \"changed=\" /var/log/ansibleEPS/.pamAccess.$timestamp.log.tmp|grep -v \"changed=0\"|wc -l` -gt 0 ] && ((echo; echo \"### CHANGES pamAccess.yml - $ini TO $(date) ###\"; echo; grep /var/log/ansibleEPS/.pamAccess.$timestamp.log.tmp -e \"^PLAY \" -e \"^TASK \" -e \"changed:\" -e \"changed=\"; echo) >> /var/log/ansibleEPS/changes.log); rm -f /var/log/ansibleEPS/.pamAccess.$timestamp.log.tmp; echo \"### pamAccess.yml - $ini TO $(date) ###\" >> /var/log/ansibleEPS/summary.log; ini=$(date); timestamp=$(date +\"\%y\%m\%d-\%H\%M\"); ansible-playbook {{ pathAnsible }}/nrpe.yml > /var/log/ansibleEPS/.nrpe.$timestamp.log.tmp 2>&1; [ $? -gt 0 ] && ((echo; echo \"### ERRORS nrpe.yml - $ini TO $(date) ###\"; echo; cat /var/log/ansibleEPS/.nrpe.$timestamp.log.tmp) >> /var/log/ansibleEPS/errors.log); [ `grep \"changed=\" /var/log/ansibleEPS/.nrpe.$timestamp.log.tmp|grep -v \"changed=0\"|wc -l` -gt 0 ] && ((echo; echo \"### CHANGES nrpe.yml - $ini TO $(date) ###\"; echo; grep /var/log/ansibleEPS/.nrpe.$timestamp.log.tmp -e \"^PLAY \" -e \"^TASK \" -e \"changed:\" -e \"changed=\"; echo) >> /var/log/ansibleEPS/changes.log); rm -f /var/log/ansibleEPS/.nrpe.$timestamp.log.tmp; echo \"### nrpe.yml - $ini TO $(date) ###\" >> /var/log/ansibleEPS/summary.log; ini=$(date); timestamp=$(date +\"\%y\%m\%d-\%H\%M\"); ansible-playbook {{ pathAnsible }}/iptables.yml > /var/log/ansibleEPS/.iptables.$timestamp.log.tmp 2>&1; [ $? -gt 0 ] && ((echo; echo \"### ERRORS iptables.yml - $ini TO $(date) ###\"; echo; cat /var/log/ansibleEPS/.iptables.$timestamp.log.tmp) >> /var/log/ansibleEPS/errors.log); [ `grep \"changed=\" /var/log/ansibleEPS/.iptables.$timestamp.log.tmp|grep -v \"changed=0\"|wc -l` -gt 0 ] && ((echo; echo \"### CHANGES iptables.yml - $ini TO $(date) ###\"; echo; grep /var/log/ansibleEPS/.iptables.$timestamp.log.tmp -e \"^PLAY \" -e \"^TASK \" -e \"changed:\" -e \"changed=\"; echo) >> /var/log/ansibleEPS/changes.log); rm -f /var/log/ansibleEPS/.iptables.$timestamp.log.tmp; echo \"### iptables.yml - $ini TO $(date) ###\" >> /var/log/ansibleEPS/summary.log; ini=$(date); timestamp=$(date +\"\%y\%m\%d-\%H\%M\"); ansible-playbook {{ pathAnsible }}/crontab.yml > /var/log/ansibleEPS/.crontab.$timestamp.log.tmp 2>&1; [ $? -gt 0 ] && ((echo; echo \"### ERRORS crontab.yml - $ini TO $(date) ###\"; echo; cat /var/log/ansibleEPS/.crontab.$timestamp.log.tmp) >> /var/log/ansibleEPS/errors.log); [ `grep \"changed=\" /var/log/ansibleEPS/.crontab.$timestamp.log.tmp|grep -v \"changed=0\"|wc -l` -gt 0 ] && ((echo; echo \"### CHANGES crontab.yml - $ini TO $(date) ###\"; echo; grep /var/log/ansibleEPS/.crontab.$timestamp.log.tmp -e \"^PLAY \" -e \"^TASK \" -e \"changed:\" -e \"changed=\"; echo) >> /var/log/ansibleEPS/changes.log); rm -f /var/log/ansibleEPS/.crontab.$timestamp.log.tmp; echo \"### crontab.yml - $ini TO $(date) ###\" >> /var/log/ansibleEPS/summary.log; ini=$(date); timestamp=$(date +\"\%y\%m\%d-\%H\%M\"); ansible-playbook {{ pathAnsible }}/proxmox.yml > /var/log/ansibleEPS/.proxmox.$timestamp.log.tmp 2>&1; [ $? -gt 0 ] && ((echo; echo \"### ERRORS proxmox.yml - $ini TO $(date) ###\"; echo; cat /var/log/ansibleEPS/.proxmox.$timestamp.log.tmp) >> /var/log/ansibleEPS/errors.log); [ `grep \"changed=\" /var/log/ansibleEPS/.proxmox.$timestamp.log.tmp|grep -v \"changed=0\"|wc -l` -gt 0 ] && ((echo; echo \"### CHANGES proxmox.yml - $ini TO $(date) ###\"; echo; grep /var/log/ansibleEPS/.proxmox.$timestamp.log.tmp -e \"^PLAY \" -e \"^TASK \" -e \"changed:\" -e \"changed=\"; echo) >> /var/log/ansibleEPS/changes.log); rm -f /var/log/ansibleEPS/.proxmox.$timestamp.log.tmp; echo \"### proxmox.yml - $ini TO $(date) ###\" >> /var/log/ansibleEPS/summary.log; ini=$(date); timestamp=$(date +\"\%y\%m\%d-\%H\%M\"); ansible-playbook {{ pathAnsible }}/baculaAdmon.yml > /var/log/ansibleEPS/.baculaAdmon.$timestamp.log.tmp 2>&1; [ $? -gt 0 ] && ((echo; echo \"### ERRORS baculaAdmon.yml - $ini TO $(date) ###\"; echo; cat /var/log/ansibleEPS/.baculaAdmon.$timestamp.log.tmp) >> /var/log/ansibleEPS/errors.log); [ `grep \"changed=\" /var/log/ansibleEPS/.baculaAdmon.$timestamp.log.tmp|grep -v \"changed=0\"|wc -l` -gt 0 ] && ((echo; echo \"### CHANGES baculaAdmon.yml - $ini TO $(date) ###\"; echo; grep /var/log/ansibleEPS/.baculaAdmon.$timestamp.log.tmp -e \"^PLAY \" -e \"^TASK \" -e \"changed:\" -e \"changed=\"; echo) >> /var/log/ansibleEPS/changes.log); rm -f /var/log/ansibleEPS/.baculaAdmon.$timestamp.log.tmp; echo \"### baculaAdmon.yml - $ini TO $(date) ###\" >> /var/log/ansibleEPS/summary.log; ini=$(date); timestamp=$(date +\"\%y\%m\%d-\%H\%M\"); ansible-playbook {{ pathAnsible }}/dhcp.yml > /var/log/ansibleEPS/.dhcp.$timestamp.log.tmp 2>&1; [ $? -gt 0 ] && ((echo; echo \"### ERRORS dhcp.yml - $ini TO $(date) ###\"; echo; cat /var/log/ansibleEPS/.dhcp.$timestamp.log.tmp) >> /var/log/ansibleEPS/errors.log); [ `grep \"changed=\" /var/log/ansibleEPS/.dhcp.$timestamp.log.tmp|grep -v \"changed=0\"|wc -l` -gt 0 ] && ((echo; echo \"### CHANGES dhcp.yml - $ini TO $(date) ###\"; echo; grep /var/log/ansibleEPS/.dhcp.$timestamp.log.tmp -e \"^PLAY \" -e \"^TASK \" -e \"changed:\" -e \"changed=\"; echo) >> /var/log/ansibleEPS/changes.log); rm -f /var/log/ansibleEPS/.dhcp.$timestamp.log.tmp; echo \"### dhcp.yml - $ini TO $(date) ###\" >> /var/log/ansibleEPS/summary.log; ini=$(date); timestamp=$(date +\"\%y\%m\%d-\%H\%M\"); ansible-playbook {{ pathAnsible }}/munin.yml > /var/log/ansibleEPS/.munin.$timestamp.log.tmp 2>&1; [ $? -gt 0 ] && ((echo; echo \"### ERRORS munin.yml - $ini TO $(date) ###\"; echo; cat /var/log/ansibleEPS/.munin.$timestamp.log.tmp) >> /var/log/ansibleEPS/errors.log); [ `grep \"changed=\" /var/log/ansibleEPS/.munin.$timestamp.log.tmp|grep -v \"changed=0\"|wc -l` -gt 0 ] && ((echo; echo \"### CHANGES munin.yml - $ini TO $(date) ###\"; echo; grep /var/log/ansibleEPS/.munin.$timestamp.log.tmp -e \"^PLAY \" -e \"^TASK \" -e \"changed:\" -e \"changed=\"; echo) >> /var/log/ansibleEPS/changes.log); rm -f /var/log/ansibleEPS/.munin.$timestamp.log.tmp; echo \"### munin.yml - $ini TO $(date) ###\" >> /var/log/ansibleEPS/summary.log; ini=$(date); timestamp=$(date +\"\%y\%m\%d-\%H\%M\"); ansible-playbook {{ pathAnsible }}/nagios.yml > /var/log/ansibleEPS/.nagios.$timestamp.log.tmp 2>&1; [ $? -gt 0 ] && ((echo; echo \"### ERRORS nagios.yml - $ini TO $(date) ###\"; echo; cat /var/log/ansibleEPS/.nagios.$timestamp.log.tmp) >> /var/log/ansibleEPS/errors.log); [ `grep \"changed=\" /var/log/ansibleEPS/.nagios.$timestamp.log.tmp|grep -v \"changed=0\"|wc -l` -gt 0 ] && ((echo; echo \"### CHANGES nagios.yml - $ini TO $(date) ###\"; echo; grep /var/log/ansibleEPS/.nagios.$timestamp.log.tmp -e \"^PLAY \" -e \"^TASK \" -e \"changed:\" -e \"changed=\"; echo) >> /var/log/ansibleEPS/changes.log); rm -f /var/log/ansibleEPS/.nagios.$timestamp.log.tmp; echo \"### nagios.yml - $ini TO $(date) ###\" >> /var/log/ansibleEPS/summary.log)"'

- name: Add ansibleEPSListaCorreos task to crontab file
  cron: 'name="ansibleEPSListaCorreos" minute="45" hour="*" day="*" weekday="*" month="*" job="cd {{ pathAnsible }} && (ini=$(date); timestamp=$(date +\"\%y\%m\%d-\%H\%M\"); ansible-playbook {{ pathAnsible }}/listaCorreos.yml > /var/log/ansibleEPS/.listaCorreos.$timestamp.log.tmp 2>&1; [ $? -gt 0 ] && ((echo; echo \"### ERRORS listaCorreos.yml - $ini TO $(date) ###\"; echo; cat /var/log/ansibleEPS/.listaCorreos.$timestamp.log.tmp) >> /var/log/ansibleEPS/errors.log); [ `grep \"changed=\" /var/log/ansibleEPS/.listaCorreos.$timestamp.log.tmp|grep -v \"changed=0\"|wc -l` -gt 0 ] && ((echo; echo \"### CHANGES listaCorreos.yml - $ini TO $(date) ###\"; echo; grep /var/log/ansibleEPS/.listaCorreos.$timestamp.log.tmp -e \"^PLAY \" -e \"^TASK \" -e \"changed:\" -e \"changed=\"; echo) >> /var/log/ansibleEPS/changes.log); rm -f /var/log/ansibleEPS/.listaCorreos.$timestamp.log.tmp; echo \"### listaCorreos.yml - $ini TO $(date) ###\" >> /var/log/ansibleEPS/summary.log)"'
